<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMeet Pro v4.6 (Light Mode)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        /* --- CSS M·ªöI: LIGHT & MODERN THEME --- */
        body { 
            background-color: #f1f5f9; /* Slate 100 - N·ªÅn s√°ng */
            color: #334155; /* Slate 700 - Ch·ªØ t·ªëi */
            font-family: 'Segoe UI', sans-serif; 
            overflow: hidden; 
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        /* Card tr·∫Øng, b√≥ng ƒë·ªï m·ªÅm */
        .video-card {
            background-color: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .video-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1); }

        /* Semantic Borders (Gi·ªØ nguy√™n m√†u logic nh∆∞ng ch·ªânh l·∫°i shadow cho n·ªÅn s√°ng) */
        .border-normal { border-color: #e2e8f0; }
        .border-good { border-color: #10b981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        .border-warn { border-color: #f59e0b; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); }
        .border-alert { border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        .border-sleep { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
        .border-think { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

        /* Sidebar tr·∫Øng */
        .side-panel {
            width: 350px; background-color: #ffffff; border-left: 1px solid #e2e8f0;
            height: calc(100vh - 80px); position: absolute; right: 0; top: 0;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40; display: flex; flex-direction: column;
            box-shadow: -5px 0 20px rgba(0,0,0,0.05);
        }
        .side-panel.open { transform: translateX(0); }

        /* Control Bar Glassmorphism s√°ng */
        .control-bar {
            height: 80px; 
            background-color: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px);
            border-top: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center; gap: 1.5rem;
            position: absolute; bottom: 0; width: 100%; z-index: 50;
        }

        .btn-ctrl {
            width: 50px; height: 50px; border-radius: 14px;
            background-color: #f8fafc; color: #64748b;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 1px solid #e2e8f0;
        }
        .btn-ctrl:hover { background-color: #e2e8f0; color: #334155; transform: translateY(-2px); }
        .btn-ctrl.active { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.25); }

        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-[600px] flex flex-col">

    <div id="loginScreen" class="fixed inset-0 z-50 bg-slate-100/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center border border-slate-200">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-6 text-3xl text-white shadow-blue-200 shadow-lg">
                <i class="fas fa-eye"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">EduMeet Pro v4.6</h2>
            <p class="text-slate-500 text-sm mb-6">AI theo d√µi h√†nh vi & Xu·∫•t b√°o c√°o</p>

            <input type="text" id="username" placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã..." class="w-full mb-4 p-3 rounded-lg bg-slate-50 border border-slate-300 text-slate-800 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition">

            <div class="space-y-3">
                <button onclick="app.join('teacher')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-blue-200">
                    <i class="fas fa-chalkboard-teacher"></i> V√†o l·ªõp (Gi√°o Vi√™n)
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.join('student', false)" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 py-3 rounded-lg font-bold text-sm transition">
                        <i class="fas fa-camera"></i> H·ªçc vi√™n (Cam)
                    </button>
                    <button onclick="app.join('student', true)" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 py-3 rounded-lg font-bold text-sm transition">
                        <i class="fas fa-gamepad"></i> HV (M√¥ ph·ªèng)
                    </button>
                </div>
            </div>
            <div class="mt-4 text-xs text-slate-400">
                *H·ªó tr·ª£ ghi log h√†nh vi ra file Excel/CSV.
            </div>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl border border-slate-200 flex flex-col animate-fade-in">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-file-alt text-blue-600"></i> Nh·∫≠t K√Ω H√†nh Vi L·ªõp H·ªçc
                </h3>
                <button onclick="app.closeReport()" class="text-slate-400 hover:text-rose-500 transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-0">
                <table class="w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-100 text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                        <tr><th class="p-4 w-32">Th·ªùi Gian</th><th class="p-4">H·ªçc Vi√™n</th><th class="p-4">H√†nh Vi Ph√°t Hi·ªán</th><th class="p-4 text-right">M·ª©c ƒê·ªô</th></tr>
                    </thead>
                    <tbody id="reportTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
                <div id="emptyReportMsg" class="hidden p-8 text-center text-slate-400 italic">ƒêang ch·ªù d·ªØ li·ªáu AI...</div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="app.closeReport()" class="px-5 py-2.5 bg-white border border-slate-300 hover:bg-slate-100 rounded-lg text-slate-600 font-bold">ƒê√≥ng</button>
                <button onclick="app.downloadZip()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold flex items-center gap-2 shadow-lg shadow-blue-200"><i class="fas fa-download"></i> T·∫£i File B√°o C√°o (.ZIP)</button>
            </div>
        </div>
    </div>

    <div id="mainInterface" class="hidden flex-1 relative flex overflow-hidden">

        <div class="flex-1 video-grid relative" id="videoGrid">
            <div class="video-card group">
                <div class="relative w-full h-full bg-slate-100"> <video id="inputVideo" class="absolute inset-0 w-full h-full object-cover opacity-0 pointer-events-none" autoplay playsinline muted></video>
                    <canvas id="outputCanvas" class="absolute inset-0 w-full h-full object-cover transform scale-x-[-1]"></canvas>
                    <div id="camPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 z-10 hidden">
                        <div class="w-24 h-24 bg-white border-4 border-blue-100 rounded-full flex items-center justify-center text-4xl font-bold text-blue-600 mb-3 pulse-ring" id="avatar">U</div>
                        <span class="text-slate-500 text-sm font-semibold" id="camStatusText">AI ƒêang Theo D√µi...</span>
                    </div>
                </div>
                <div class="absolute bottom-3 left-3 bg-white/90 px-3 py-1 rounded-lg text-xs font-bold backdrop-blur z-20 text-slate-800 shadow-sm border border-slate-100">
                    B·∫°n (<span id="roleLabel">...</span>)
                </div>
                <div class="absolute top-3 left-3 z-20">
                    <div id="statusPill" class="px-4 py-2 rounded-full bg-white/90 backdrop-blur text-xs font-bold border-l-4 border-slate-300 flex items-center gap-2 text-slate-600 shadow-md transition-all duration-300">
                        <i class="fas fa-circle-notch fa-spin text-slate-400"></i> ƒêang t·∫£i AI...
                    </div>
                </div>
            </div>
            <div id="remoteGrid" class="contents"></div>
        </div>

        <div id="sidebar" class="side-panel">
            <div class="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
                <h3 class="font-bold text-sm text-slate-800 flex items-center gap-2"><i class="fas fa-chart-bar text-blue-600"></i> Theo D√µi Real-time</h3>
                <button onclick="app.toggleSidebar()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between mb-2 text-xs font-bold text-slate-500 uppercase">
                        <span>T·∫≠p Trung Trung B√¨nh</span>
                        <span class="text-emerald-600" id="avgFocus">--%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="bg-emerald-500 h-2 rounded-full" style="width: 75%"></div>
                    </div>
                </div>

                <div class="text-xs text-slate-400 uppercase font-bold mt-4">Tr·∫°ng th√°i l·ªõp h·ªçc</div>
                <div class="space-y-2" id="studentList"></div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-white space-y-2">
                <button onclick="app.viewReport()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-xs py-3 rounded-lg font-bold transition flex items-center justify-center gap-2"><i class="fas fa-list-alt"></i> Xem Nh·∫≠t K√Ω</button>
                <button onclick="app.downloadZip()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-blue-100"><i class="fas fa-file-export"></i> Xu·∫•t B√°o C√°o</button>
            </div>
        </div>
    </div>

    <div id="controlBar" class="control-bar hidden">
        <div class="btn-ctrl" onclick="app.toggleMic()" title="Mic"><i class="fas fa-microphone"></i></div>
        <div class="btn-ctrl" onclick="app.toggleCam()" title="Camera"><i class="fas fa-video"></i></div>
        <div class="w-px h-8 bg-slate-300 mx-2"></div>
        <div class="btn-ctrl active" onclick="app.toggleSidebar()" title="Th·ªëng k√™"><i class="fas fa-chart-pie"></i></div>
        <div class="btn-ctrl" title="Chat" onclick="alert('Chat Demo')"><i class="fas fa-comment-alt"></i></div>
        <div class="w-px h-8 bg-slate-300 mx-2"></div>
        <button onclick="location.reload()" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-full font-bold text-sm transition shadow-lg shadow-rose-200">K·∫øt th√∫c</button>
    </div>

    <script>
        // --- 1. CORE AI ENGINE (MZEAM v4.6 - Tracking & Logging) ---
        // --- 1. CORE AI ENGINE (HARDCORE MODE üî•) ---
        const AI_ENGINE = {
            historyBuffer: [],
            BUFFER_SIZE: 15, // Gi·∫£m buffer xu·ªëng ƒë·ªÉ AI ph·∫£n ·ª©ng nhanh h∆°n (0.5s l√† b·∫Øt ƒë∆∞·ª£c)
            prevWrists: { left: null, right: null },

            process: function(landmarks) {
                if (!landmarks) return { label: "V·∫ÆNG M·∫∂T ‚ùå", color: "text-rose-600", border: "border-alert" };

                const nose = landmarks[0];
                const leftEye = landmarks[1];
                const rightEye = landmarks[2];
                const leftEar = landmarks[7];
                const rightEar = landmarks[8];
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                
                // T√≠nh to√°n c√°c ch·ªâ s·ªë c∆° b·∫£n
                const shoulderY = (leftShoulder.y + rightShoulder.y) / 2;
                const shoulderX = (leftShoulder.x + rightShoulder.x) / 2;
                const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x); // ƒê·ªô r·ªông vai l√†m th∆∞·ªõc ƒëo chu·∫©n
                const eyeMidY = (leftEye.y + rightEye.y) / 2;

                // 1. Ph√¢n t√≠ch c·ª≠ ch·ªâ ƒë·∫ßu (D√πng l·ªãch s·ª≠ di chuy·ªÉn)
                this.updateHistory(nose);
                const headGesture = this.detectHeadGesture();

                // --- LOGIC B·∫ÆT L·ªñI G·∫ÆT (STRICT RULES) ---

                // A. PH√ÅT HI·ªÜN NG·ª¶ (SLEEPING) - Logic G·∫Øt
                // ƒêi·ªÅu ki·ªán: M≈©i r∆°i xu·ªëng th·∫•p qu√° 1/2 kho·∫£ng c√°ch t·ª´ m·∫Øt ƒë·∫øn vai (g·ª•c ƒë·∫ßu)
                // HO·∫∂C: ƒê·∫ßu ng·ª≠a ra sau (M≈©i cao h∆°n m·∫Øt qu√° nhi·ªÅu) -> Ng·ªß g·∫≠t tr√™n gh·∫ø
                const distEyeToShoulder = Math.abs(shoulderY - eyeMidY);
                const distNoseToShoulder = Math.abs(shoulderY - nose.y);

                // N·∫øu kho·∫£ng c√°ch m≈©i-vai qu√° g·∫ßn (g·ª•c) v√† √≠t chuy·ªÉn ƒë·ªông
                if ((distNoseToShoulder < distEyeToShoulder * 0.4) && headGesture === "STILL") {
                     return { label: "ƒêANG NG·ª¶ üò¥", color: "text-purple-600", border: "border-sleep" };
                }

                // B. PH√ÅT HI·ªÜN M·∫§T T·∫¨P TRUNG (DISTRACTION) - Logic G·∫Øt
                
                // B1. Quay ngang (Horizontal Turn):
                // C≈©: > 0.5 (R·∫•t r·ªông). M·ªõi: > 0.2 (Ch·ªâ c·∫ßn l·ªách pha nh·∫π kh·ªèi t√¢m vai)
                const noseOffset = Math.abs(nose.x - shoulderX);
                if (noseOffset > shoulderWidth * 0.25) { 
                    return { label: "M·∫§T T·∫¨P TRUNG üëÄ", color: "text-rose-600", border: "border-alert" };
                }

                // B2. Nghi√™ng ƒë·∫ßu (Tilt):
                // So s√°nh ƒë·ªô cao 2 tai. N·∫øu ch√™nh l·ªách l·ªõn => ƒêang d·ª±a ƒë·∫ßu ho·∫∑c nghe ƒëi·ªán tho·∫°i
                const earDiff = Math.abs(leftEar.y - rightEar.y);
                if (earDiff > shoulderWidth * 0.15) {
                    return { label: "NGHI√äNG ƒê·∫¶U ‚ö†Ô∏è", color: "text-amber-600", border: "border-warn" };
                }

                // B3. C√∫i d√πng ƒëi·ªán tho·∫°i (Looking Down):
                // M≈©i th·∫•p h∆°n tai ƒë√°ng k·ªÉ, nh∆∞ng ch∆∞a ƒë·∫øn m·ª©c ng·ªß
                if (nose.y > leftEar.y + 0.1 && nose.y > rightEar.y + 0.1) {
                     return { label: "C√öI ƒê·∫¶U üì±", color: "text-rose-500", border: "border-alert" };
                }

                // C. C√ÅC TR·∫†NG TH√ÅI T√çCH C·ª∞C
                // Gi∆° tay
                if (landmarks[15].y < leftShoulder.y - 0.2 || landmarks[16].y < rightShoulder.y - 0.2) {
                    return { label: "GI∆† TAY ‚úã", color: "text-emerald-600", border: "border-good" };
                }
                
                if (headGesture === "NOD") return { label: "G·∫¨T ƒê·∫¶U üëç", color: "text-emerald-600", border: "border-good" };
                if (headGesture === "SHAKE") return { label: "L·∫ÆC ƒê·∫¶U üëé", color: "text-orange-500", border: "border-warn" };

                // M·∫∑c ƒë·ªãnh
                return { label: "L·∫ÆNG NGHE ‚úÖ", color: "text-blue-600", border: "border-normal" };
            },

            updateHistory: function(nose) {
                this.historyBuffer.push({x: nose.x, y: nose.y, t: Date.now()});
                if (this.historyBuffer.length > this.BUFFER_SIZE) this.historyBuffer.shift();
            },

            detectHeadGesture: function() {
                if (this.historyBuffer.length < 5) return "MOVING"; // C·∫ßn √≠t frame h∆°n ƒë·ªÉ ph√°n ƒëo√°n
                let xMin=1, xMax=0, yMin=1, yMax=0;
                this.historyBuffer.forEach(p => {
                    if(p.x < xMin) xMin = p.x; if(p.x > xMax) xMax = p.x;
                    if(p.y < yMin) yMin = p.y; if(p.y > yMax) yMax = p.y;
                });
                const xRange = xMax - xMin;
                const yRange = yMax - yMin;

                // Threshold nh·∫°y h∆°n
                if (yRange > 0.03 && xRange < 0.015) return "NOD";
                if (xRange > 0.03 && yRange < 0.015) return "SHAKE";
                if (xRange < 0.005 && yRange < 0.005) return "STILL"; // R·∫•t tƒ©nh
                return "MOVING";
            }
        };

        // --- 2. APP LOGIC ---
        const app = {
            state: { role: null, username: "Guest", isSimulation: false, logs: {}, localLog: [] },

            join: async (role, forceSim) => {
                app.state.role = role;
                app.state.username = document.getElementById('username').value || (role === 'teacher' ? 'Gi√°o Vi√™n' : 'H·ªçc Vi√™n');
                app.state.isSimulation = forceSim;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainInterface').classList.remove('hidden');
                document.getElementById('controlBar').classList.remove('hidden');
                document.getElementById('roleLabel').innerText = role === 'teacher' ? 'Ch·ªß ph√≤ng' : 'H·ªçc vi√™n';
                document.getElementById('avatar').innerText = app.state.username.charAt(0).toUpperCase();

                if (role === 'teacher') {
                    app.setupTeacherMode();
                    document.getElementById('sidebar').classList.add('open');
                } else {
                    app.setupStudentMode();
                }

                if (forceSim) app.startSimulation();
                else app.startCamera();
            },

            // X·ª¨ L√ù CAMERA TH·∫¨T & GHI LOG
            startCamera: async () => {
                document.getElementById('camPlaceholder').classList.remove('hidden');
                document.getElementById('camStatusText').innerText = "ƒêang xin quy·ªÅn Camera...";
                try {
                    if (typeof Pose === 'undefined') throw new Error("AI not ready");
                    const video = document.getElementById('inputVideo');
                    const canvas = document.getElementById('outputCanvas');
                    const ctx = canvas.getContext('2d');

                    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
                    pose.setOptions({modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5});

                    pose.onResults((results) => {
                        ctx.save();
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
                        let status = {label: "V·∫ÆNG M·∫∂T", color: "text-rose-600", border: "border-alert"};

                        if (results.poseLandmarks) {
                            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: 'rgba(59, 130, 246, 0.5)', lineWidth: 2});
                            drawLandmarks(ctx, results.poseLandmarks, {color: 'rgba(239, 68, 68, 0.5)', lineWidth: 1});
                            status = AI_ENGINE.process(results.poseLandmarks);
                        }

                        app.updateUI(status);
                        app.logLocalUser(status.label); 
                        ctx.restore();
                    });

                    const camera = new Camera(video, { onFrame: async () => { await pose.send({image: video}); }, width: 480, height: 270 });
                    await camera.start();
                    document.getElementById('camPlaceholder').classList.add('hidden');
                    document.getElementById('outputCanvas').style.opacity = '1';
                } catch (e) {
                    console.warn(e);
                    alert("Camera kh√¥ng kh·∫£ d·ª•ng. Chuy·ªÉn sang m√¥ ph·ªèng.");
                    app.startSimulation();
                }
            },

            // SIMULATION
            startSimulation: () => {
                document.getElementById('camPlaceholder').classList.remove('hidden');
                document.getElementById('camStatusText').innerText = "Ch·∫ø ƒë·ªô AI M√¥ Ph·ªèng";
                document.getElementById('outputCanvas').style.opacity = '0';

                setInterval(() => {
                    const states = [
                        { label: "L·∫ÆNG NGHE üëÇ", color: "text-blue-600", border: "border-normal", w: 0.4 },
                        { label: "G·∫¨T ƒê·∫¶U üëç", color: "text-emerald-600", border: "border-good", w: 0.6 },
                        { label: "SUY NGHƒ® ü§î", color: "text-blue-500", border: "border-think", w: 0.7 },
                        { label: "ƒÇN U·ªêNG üçî", color: "text-amber-500", border: "border-warn", w: 0.8 },
                        { label: "GI∆† TAY ‚úã", color: "text-emerald-600", border: "border-good", w: 0.9 },
                        { label: "ƒêANG NG·ª¶ üò¥", color: "text-purple-600", border: "border-sleep", w: 0.95 },
                        { label: "L·∫ÆC ƒê·∫¶U üëé", color: "text-orange-500", border: "border-warn", w: 1.0 }
                    ];
                    const r = Math.random();
                    const status = states.find(s => r < s.w) || states[0];
                    app.updateUI(status);
                    app.logLocalUser(status.label);
                }, 2000);
            },

            updateUI: (status) => {
                const pill = document.getElementById('statusPill');
                pill.innerHTML = `<span class="${status.color}"><i class="fas fa-circle text-[8px] animate-pulse mr-2"></i>${status.label}</span>`;
                pill.className = `px-4 py-2 rounded-full bg-white/90 backdrop-blur text-xs font-bold border-l-4 ${status.border} shadow-md transition-all duration-300 text-slate-700`;
                pill.closest('.video-card').className = `video-card transition-all duration-300 ${status.border}`;
            },

            logLocalUser: (state) => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                const lastLog = app.state.localLog[app.state.localLog.length - 1];
                if (!lastLog || (now - lastLog.ts > 1000)) {
                    app.state.localLog.push({ time: timeStr, state: state, ts: now });
                }
            },

            setupTeacherMode: () => {
                // Danh s√°ch video m·∫´u (ng∆∞·ªùi ng·ªìi h·ªçc/l√†m vi·ªác)
                const fakeVideos = [
                  "https://cdn.save.moe/s9/rYmfOS.mp4",
                    "https://cdn.save.moe/s9/CTwSM4f.mp4", // Nam ƒëang t·∫≠p trung
                    "https://cdn.save.moe/s9/SyNBMJ.mp4", // N·ªØ ƒëang l√†m vi·ªác
                    "https://cdn.save.moe/s9/HlOc7m.mp4", // N·ªØ m·ªát m·ªèi/Ng·ªß
                    "https://cdn.save.moe/s9/qXvmpGOs.mp4",
                    
                     // Nam ch∆°i game/M·∫•t t·∫≠p trung
                ];

                const students = [
                  {id: "SV1", name: "B√¨nh Minh", vid: fakeVideos[0]}, 
                    {id: "SV2", name: "Thu H√† ", vid: fakeVideos[1]},
                    {id: "SV3", name: "B·∫£o Ng·ªçc", vid: fakeVideos[2]}, 
                    {id: "SV4", name: "Ho√†ng Nam", vid: fakeVideos[3]},
                    {id: "SV5", name: "Minh Tu·∫•n ", vid: fakeVideos[4]}
                    
                ];
                students.forEach(s => app.state.logs[s.id] = []);

                const grid = document.getElementById('remoteGrid');
                
                // T·∫†O TH·∫∫ VIDEO THAY V√å CH·ªà HI·ªÜN TEXT
                grid.innerHTML = students.map(s => `
                    <div class="video-card relative bg-white overflow-hidden border-3 border-transparent transition-all duration-300 shadow-sm" id="card-${s.id}">
                        <video src="${s.vid}" autoplay loop muted class="absolute inset-0 w-full h-full object-cover"></video>
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>

                        <div class="absolute bottom-3 left-3 right-3 text-white">
                            <div class="text-xs font-bold text-slate-200">${s.name}</div>
                            <div class="mt-1 inline-block px-2 py-1 bg-black/60 backdrop-blur rounded text-[10px] font-mono border border-white/20" id="status-${s.id}">
                                ƒêang ph√¢n t√≠ch...
                            </div>
                        </div>
                    </div>`).join('');

                // LOGIC RANDOM TR·∫†NG TH√ÅI (AI GI·∫¢ L·∫¨P CHO VIDEO)
                const START_TIME = Date.now();

                setInterval(() => {
                    // T√≠nh th·ªùi gian tr√¥i qua (gi√¢y)
                    const seconds = (Date.now() - START_TIME) / 1000;
                    
                    let alerts = 0, focusSum = 0, listHtml = "";

                    students.forEach((s, index) => {
                        let st = { txt: "L·∫ÆNG NGHE üëÇ", col: "text-blue-500", brd: "border-normal", score: 100 }; // M·∫∑c ƒë·ªãnh
                        let isAbsent = false; // C·ªù ki·ªÉm tra v·∫Øng m·∫∑t

                        // === X·ª¨ L√ù RI√äNG CHO B√åNH MINH (INDEX 4) ===
                        if (index === 0) { 
                            if (seconds < 4.3) {
                                // 0s -> 10s: L·∫Øng nghe
                                st = { txt: "L·∫ÆNG NGHE üëÇ", col: "text-blue-500", brd: "border-normal", score: 100 };
                            } else if (seconds < 8.5) {
                                // 10s -> 20s: Ng·ªß g·ª•c
                                st = { txt: "ƒêANG NG·ª¶ üò¥", col: "text-purple-500", brd: "border-sleep", score: 10 };
                            } else if (seconds < 13) {
                                // 20s -> 30s: M·∫•t t·∫≠p trung
                                st = { txt: "M·∫§T T·∫¨P TRUNG üëÄ", col: "text-rose-500", brd: "border-alert", score: 40 };
                            } else if (seconds < 19) {
                                // 30s -> 40s: Gi∆° tay
                                st = { txt: "GI∆† TAY ‚úã", col: "text-emerald-500", brd: "border-good", score: 100 };
                            }else if (seconds < 22) {
                                // 30s -> 40s: Gi∆° tay
                                st = { txt: "V·∫ÆNG M·∫∂T ‚ùå", col: "text-slate-500", brd: "border-normal", score: 0 }; 
                                isAbsent = true;
                            }else {
                                // 40s tr·ªü ƒëi: V·∫Øng m·∫∑t
                                st = { txt: "L·∫ÆNG NGHE üëÇ", col: "text-blue-500", brd: "border-normal", score: 100 };
                            }
                        } 
                        // === C√ÅC B·∫†N KH√ÅC (GI·ªÆ NGUY√äN HO·∫∂C RANDOM NH·∫∏) ===
                        else {
                            // ƒê·ªÉ c√°c b·∫°n kh√°c random nh·∫π cho t·ª± nhi√™n (ho·∫∑c g√°n c·ª©ng l√† ChƒÉm ch·ªâ n·∫øu mu·ªën)
                            // ·ªû ƒë√¢y m√¨nh ƒë·ªÉ random nh·∫π tr·∫°ng th√°i t·ªët
                            const r = Math.random();
                            if (r > 0.75) st = { txt: "G·∫¨T ƒê·∫¶U üëç", col: "text-emerald-500", brd: "border-good", score: 95 };
                            else st = { txt: "L·∫ÆNG NGHE üëÇ", col: "text-blue-500", brd: "border-normal", score: 100 };
                        }

                        // C·∫≠p nh·∫≠t giao di·ªán
                        const statusTag = document.getElementById(`status-${s.id}`);
                        if(statusTag) statusTag.innerHTML = `<span class="${st.col.replace('text-', 'text-')}">${st.txt}</span>`; // Hack m√†u ch·ªØ cho n·ªïi tr√™n n·ªÅn video t·ªëi
                        
                        const card = document.getElementById(`card-${s.id}`);
                        if(card) card.className = `video-card relative bg-black overflow-hidden transition-all duration-300 ${st.brd}`;

                        // Ghi log & Sidebar
                        app.state.logs[s.id].push({time: new Date().toLocaleTimeString(), state: st.txt, name: s.name});
                        listHtml += `<div class="bg-white p-2 rounded-lg flex justify-between items-center text-xs group hover:bg-slate-50 border border-slate-100 transition shadow-sm mb-2">
                            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${st.score > 80 ? 'bg-emerald-500' : 'bg-rose-500'}"></div><span class="font-bold text-slate-700">${s.name}</span></div>
                            <span class="font-mono ${st.col}">${st.txt}</span></div>`;
                        focusSum += st.score;
                    });
                    
                    const sl = document.getElementById('studentList');
                    if(sl) sl.innerHTML = listHtml;
                    
                    const af = document.getElementById('avgFocus');
                    if(af) af.innerText = Math.round(focusSum/students.length) + "%";
                }, 1500);
            },
            setupStudentMode: () => {
                document.getElementById('remoteGrid').innerHTML = `<div class="video-card flex items-center justify-center bg-white"><div class="text-center"><div class="w-20 h-20 bg-slate-50 border border-slate-200 rounded-2xl mx-auto flex items-center justify-center text-3xl mb-3">üë®‚Äçüè´</div><div class="font-bold text-lg text-slate-700">Gi·∫£ng Vi√™n</div><div class="text-xs text-emerald-600 mt-1 animate-pulse">‚óè ƒêang tr√¨nh b√†y</div></div></div>`;
            },

            // --- UTILS & EXPORT ---
            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('open'),
            toggleMic: () => alert("Microphone (Demo)"),
            toggleCam: () => alert("Camera Toggle (Demo)"),

            viewReport: () => {
                const tbody = document.getElementById('reportTableBody');
                tbody.innerHTML = '';
                let hasData = false;

                // Local User Log
                if(app.state.localLog.length > 0) {
                    hasData = true;
                    const recentLogs = app.state.localLog.slice(-5).reverse();
                    recentLogs.forEach(l => {
                        tbody.innerHTML += `<tr class="bg-blue-50/50"><td class="p-4 font-mono text-xs text-slate-500">${l.time}</td><td class="p-4 font-bold text-blue-600">B·∫†N (T√¥i)</td><td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold bg-white border border-slate-200 shadow-sm text-slate-600">${l.state}</span></td><td class="p-4 text-right">---</td></tr>`;
                    });
                }

                // Remote Logs
                for (const [id, logs] of Object.entries(app.state.logs)) {
                    if (logs.length > 0) {
                        hasData = true;
                        const recentLogs = logs.slice(-5).reverse();
                        const name = recentLogs[0].name || id;
                        recentLogs.forEach(l => {
                            let badgeColor = "bg-slate-100 text-slate-600 border border-slate-200";
                            if (l.state.includes("T·∫¨P") || l.state.includes("BU·ªíN") || l.state.includes("NG·ª¶")) badgeColor = "bg-rose-50 text-rose-600 border border-rose-100";
                            if (l.state.includes("GI∆†") || l.state.includes("L·∫ÆNG") || l.state.includes("G·∫¨T")) badgeColor = "bg-emerald-50 text-emerald-600 border border-emerald-100";
                            tbody.innerHTML += `<tr class="hover:bg-slate-50 transition"><td class="p-4 font-mono text-xs text-slate-500">${l.time}</td><td class="p-4 font-bold text-slate-700">${name}</td><td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeColor} shadow-sm">${l.state}</span></td><td class="p-4 text-right">...</td></tr>`;
                        });
                    }
                }
                document.getElementById('emptyReportMsg').classList.toggle('hidden', hasData);
                document.getElementById('reportModal').classList.remove('hidden');
            },
            closeReport: () => document.getElementById('reportModal').classList.add('hidden'),

            downloadZip: async () => {
                if (typeof JSZip === 'undefined') return alert("ƒêang t·∫£i th∆∞ vi·ªán ZIP...");
                const zip = new JSZip();
                const folder = zip.folder("Bao_Cao_Lop");
                let hasData = false;

                if (app.state.localLog.length > 0) {
                    hasData = true;
                    let csv = "\uFEFFTime,State\\n";
                    app.state.localLog.forEach(l => csv += `${l.time},${l.state}\\n`);
                    folder.file(`BaoCao_Ban_Than.csv`, csv);
                }

                for (const [id, logs] of Object.entries(app.state.logs)) {
                    if (logs.length > 0) {
                        hasData = true;
                        let csv = "\uFEFFTime,State\\n";
                        logs.forEach(l => csv += `${l.time},${l.state}\\n`);
                        folder.file(`HocVien_${id}.csv`, csv);
                    }
                }

                if(!hasData) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
                try {
                    const content = await zip.generateAsync({type:"blob"});
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(content);
                    link.download = `Full_Report_${Date.now()}.zip`;
                    link.click();
                } catch(e) { alert("L·ªói n√©n file: " + e); }
            }
        };
    </script>
</body>
</html>